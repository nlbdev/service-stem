name: Pull Request Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10.13.1
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: pnpm
        
    - name: Verify pnpm installation
      run: |
        echo "Node version: $(node --version)"
        echo "pnpm version: $(pnpm --version)"
        echo "pnpm location: $(which pnpm)"
        
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: Run linting
      id: lint
      run: |
        pnpm lint
        echo "exit_code=$?" >> $GITHUB_OUTPUT
      continue-on-error: true
      
    - name: Run tests
      id: test
      run: |
        pnpm test:coverage
        echo "exit_code=$?" >> $GITHUB_OUTPUT
      continue-on-error: true
      
    - name: Check test coverage
      id: coverage
      run: |
        if [ -f "./coverage/coverage-summary.json" ]; then
          COVERAGE=$(node -e "console.log(require('./coverage/coverage-summary.json').total.lines.pct)")
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          if [ $(echo "$COVERAGE < 65" | bc -l) -eq 1 ]; then
            echo "Test coverage is below 65%"
            exit 1
          fi
        else
          echo "coverage=0" >> $GITHUB_OUTPUT
          echo "Coverage file not found"
          exit 1
        fi
      continue-on-error: true
        
    - name: Comment PR with results
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const fs = require('fs');
          
          let coverage = 0;
          let coverageStatus = '❌ Coverage file not found';
          
          try {
            if (fs.existsSync('./coverage/coverage-summary.json')) {
              const coverageData = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
              coverage = coverageData.total.lines.pct;
              coverageStatus = coverage >= 65 ? '✅ Coverage meets requirements' : '⚠️ Coverage is below 65% threshold';
            }
          } catch (error) {
            console.error('Error reading coverage file:', error);
          }
          
          const lintStatus = '${{ steps.lint.outputs.exit_code }}' === '0' ? '✅ Passed' : '❌ Failed';
          const testStatus = '${{ steps.test.outputs.exit_code }}' === '0' ? '✅ Passed' : '❌ Failed';
          
          const comment = `## PR Check Results
          
          ${lintStatus} **Linting**
          ${testStatus} **Tests**
          📊 **Coverage**: ${coverage}%
          
          ${coverageStatus}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          }); 